</head>

<body>
  <div id="sidebar">
    <a href="javascript:void(0)" onclick="toggleSidebar()">â¬… Back</a>
    <a href="/chat">ğŸ’¬ Chat</a>
    <div class="hub-toggle" onclick="toggleHub()">ğŸŒ Hub â–¼</div>
    <div class="hub-content" id="hub">
      <a href="/upgrade">âš¡ Upgrade</a>
      <a href="/analytics">ğŸ“Š Analytics</a>
      <a href="/logs">ğŸ“œ Logs</a>
      <a href="/tiers">ğŸ“– Tiers</a>
      <a href="/referral">ğŸ Invite</a>
      <a href="/evostoken">ğŸª™ EvosToken</a>
      {% if tier in ["King", "Founder"] %}
        <a href="/admin">ğŸ›  Admin</a>
      {% endif %}
      <a href="javascript:void(0)" onclick="clearChat()">ğŸ§¹ Clear Chat</a>
      {% if not logged_in %}
        <a href="/login">ğŸ”‘ Login</a>
        <a href="/register">ğŸ“ Register</a>
      {% else %}
        <a href="/logout">ğŸšª Logout</a>
      {% endif %}
    </div>
  </div>
  <div id="overlay" onclick="toggleSidebar()"></div>

  {% if tier not in ["King", "Founder"] %}
    <button id="upgrade-btn" onclick="location.href='/upgrade'">âš¡ Upgrade Tier</button>
  {% endif %}

  <div id="main-wrapper">
    <header>
      <span class="menu-btn" onclick="toggleSidebar()">â˜°</span>
      <h1>
        <img src="{{ url_for('static', filename='images/evosgpt-icon.png') }}" alt="EVOSGPT Logo">
        EVOSGPT {{ icon }} {{ tier }} Mode
      </h1>
      <div class="auth-links">
        {% if not logged_in %}
          <a href="/login">ğŸ”‘ Login</a>
          <a href="/register">ğŸ“ Register</a>
        {% else %}
          <a href="/logout">ğŸšª Logout</a>
        {% endif %}
        <button id="theme-toggle">ğŸŒ™</button>
      </div>
    </header>

    <div id="chat-box"></div>
  </div>

  <form id="chat-form">
    <textarea id="message" placeholder="Type your message..." rows="1"></textarea>
    <button type="submit">Send</button>
  </form>

  <script>
    const chatBox = document.getElementById("chat-box");
    const textarea = document.getElementById("message");

    function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }

    function saveChat() { localStorage.setItem("evos_chat_history", chatBox.innerHTML); }
    function loadChat() {
      const saved = localStorage.getItem("evos_chat_history");
      if (saved) {
        chatBox.innerHTML = saved;
        adjustChatPadding();
        scrollToBottom();
      }
    }
    function clearChat() {
      localStorage.removeItem("evos_chat_history");
      chatBox.innerHTML = "";
    }

    loadChat();

    document.getElementById("chat-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = textarea.value.trim();
      if (!text) return;

      chatBox.insertAdjacentHTML("beforeend", `<div class="msg user">${text}</div>`);
      saveChat(); scrollToBottom();
      textarea.value = ""; textarea.style.height = "40px"; adjustChatPadding();

      const typing = document.createElement("div");
      typing.className = "msg bot"; typing.id = "typing-bubble"; typing.innerText = "EVOSGPT is typing...";
      chatBox.appendChild(typing); scrollToBottom();

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        typing.remove();

        let botContent = "";
        if (data.image_url) {
          botContent = `<img src="${data.image_url}" alt="Generated Image" style="max-width:100%; border-radius:10px; margin-top:8px;">`;
        } else if (data.image_base64) {
          botContent = `<img src="data:image/png;base64,${data.image_base64}" alt="Generated Image" style="max-width:100%; border-radius:10px; margin-top:8px;">`;
        } else {
          botContent = marked.parse(data.reply || "âš  No reply from server.");
        }

        chatBox.insertAdjacentHTML("beforeend", `
          <div class="msg bot">
            <strong>EVOSGPT [${data.tier || "?"}]</strong><br>
            <div class="bot-content">${botContent}</div>
            <button class="copy-btn" onclick="copyText(this)">ğŸ“‹</button>
          </div>
        `);
        saveChat(); adjustChatPadding(); scrollToBottom();
      } catch (err) {
        typing.remove();
        chatBox.insertAdjacentHTML("beforeend", `<div class="msg bot error">âš  Error: ${err.message}</div>`);
        saveChat();
      }
    });

    textarea.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey && window.innerWidth > 768) {
        e.preventDefault();
        document.getElementById("chat-form").dispatchEvent(new Event("submit"));
      }
    });

    function copyText(button) {
      const text = button.parentElement.innerText.replace("ğŸ“‹", "").trim();
      navigator.clipboard.writeText(text).then(() => {
        button.textContent = "âœ…";
        setTimeout(() => button.textContent = "ğŸ“‹", 1500);
      });
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
      document.getElementById("overlay").classList.toggle("active");
    }

    function toggleHub() {
      const hub = document.getElementById("hub");
      hub.style.display = hub.style.display === "block" ? "none" : "block";
    }

    function adjustChatPadding() {
      const form = document.getElementById("chat-form");
      chatBox.style.paddingBottom = `${form.offsetHeight + 20}px`;
    }

    window.addEventListener("resize", adjustChatPadding);
    adjustChatPadding();

    const themeToggle = document.getElementById("theme-toggle");
    themeToggle.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme");
      const newTheme = current === "dark" ? "light" : "dark";
      document.body.setAttribute("data-theme", newTheme);
      themeToggle.textContent = newTheme === "dark" ? "â˜€" : "ğŸŒ™";
      localStorage.setItem("theme", newTheme);
    });

    const savedTheme = localStorage.getItem("theme");
    document.body.setAttribute("data-theme", savedTheme || "light");
    themeToggle.textContent = savedTheme === "dark" ? "â˜€" : "ğŸŒ™";
  </script>
</body>
</html>
